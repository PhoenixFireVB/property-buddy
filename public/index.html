<!DOCTYPE html>
<html>

<head>
  <title>Property Buddy</title>
  <meta charset="utf-8">
  <style type="text/css">
    body {
      font-family: sans-serif;
      font-size: 48px !important;
      text-align: center;
      color: #383838;
    }

    .aicuz,
    .flood {
      font-size: 96px;
      margin: 0px;
    }

    .preamble {
      margin-top: 20px;
      margin-bottom: 0px;
    }

    .no-zone {
      background-color: #00ff00;
    }

    ._50 {
      background-color: #55ff00;
    }

    ._55 {
      background-color: #80ff00;
    }

    ._60 {
      background-color: #aaff00;
    }

    ._65 {
      background-color: #d5ff00;
    }

    ._70 {
      background-color: #ffff00;
    }

    ._75 {
      background-color: #ffd500;
    }

    ._80 {
      background-color: #ff5500;
    }

    ._85 {
      background-color: #ff0000;
    }


  </style>
  <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css"></link>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-1 col-lg-1">
      </div>
      <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
        <div id="location">
          <p>Searching Location...</p>
        </div>
        <div id="aicuz">
          <p>AICUZ...</p>
        </div>
        <div class="row container">
          <div class="col-md-1 col-lg-1">
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _50">
            50
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _55">
            55
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _60">
            60
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _65">
            65
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _70">
            70
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _75">
            75
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _80">
            80
          </div>
          <div class="col-xs-3 col-sm-3 col-md-1 col-lg-1 _85">
            85
          </div>
          <div class="col-md-1 col-lg-1">
          </div>
        </div>
        <div id="flood">
          <p>Flood Zone...</p>
        </div>
      </div>
      <div class="col-md-1 col-lg-1">
      </div>
    </div>
  </div>
</body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/d3-collection.v1.min.js"></script>
<script src="//d3js.org/d3-dispatch.v1.min.js"></script>
<script src="//d3js.org/d3-dsv.v1.min.js"></script>
<script src="//d3js.org/d3-request.v1.min.js"></script>
<script src="//d3js.org/d3-array.v1.min.js"></script>
<script src="//d3js.org/d3-geo.v1.min.js"></script>
<script src="/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script>
  function checkAICUZ(position) {

    console.log("Checking features for position:");
    console.log(position);

    var ll = [position.coords.longitude, position.coords.latitude];
    //var ll = [-76.195987, 36.893076]; // NFK

    d3.json("geojson/Norfolk.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in NFK");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is NFK");
        checkAICUZ_NFK(ll);
        checkFloodZone_NFK(ll);
      } else {
        console.log("Location is not in NFK")
      }
    });

    d3.json("geojson/VirginiaBeach.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in VB");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is VB");
        var msg = "<p>You are in Virginia Beach</p>";
        d3.select("#location").html(msg);
        checkAICUZ_VB(ll);
        checkFloodZone_VB(ll);
      } else {
        console.log("Location is not in VB")
      }
    });

  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(checkAICUZ);
    } else {
      d3.select("body").append("span")
        .text("Geolocation is not supported by this browser.");
    }
  }

  function checkAICUZ_NFK(ll) {
    d3.request("https://data-orf.opendata.arcgis.com/datasets/c8de1a1f81e14eacbe381ae342318031_8.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p class='preamble'>AICUZ Noise Zone:</p>";

        var z = checkFeaturesForAICUZNoiseLevel(data.features, ll, "NFK");

        if (z == "") {
          z = "<p>You are not in any AICUZ Noise Zone.</p>"
        }

        msg += z;

        d3.select("#aicuz").html(msg);

      });
  }

  function checkAICUZ_VB(ll) {
    d3.request("https://gis-vbgov.opendata.arcgis.com/datasets/3088488c6c284f3981d61b9efe9c1d04_3.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p class='preamble'>AICUZ Noise Zone</p>";

        msg += checkFeaturesForAICUZNoiseLevel(data.features, ll, "VB");

        d3.select("#aicuz").html(msg);

      });
  }

  // TODO: update from 2009 to 2015. Something wrong with the 2015 API
  function checkFloodZone_VB(ll) {
    d3.request("https://gis-vbgov.opendata.arcgis.com/datasets/380ebd14bb214b758ea2d50b11dfe73b_2.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        console.log("Checking features for Flood Zone");

        var msg = "<p class='preamble'>Flood Zone (2009)</p>";

        msg += checkFeaturesForFloodZone(data.features, ll, "VB");

        d3.select("#flood").html(msg);

      });
  }

  function checkFeaturesForAICUZNoiseLevel(features, ll, city) {
    var msg = "";
    var lvl = 0;
    $(features).each(function() {
      var f = $(this);
      if (f && f[0]) {
        if (d3.geoContains(f[0], ll)) {
          switch (city) {
            case "NFK":
              {
                lvl = parseInt(f[0].properties.NOISE_LEV_);
                msg += "<p class='aicuz'>" + lvl + "</p>";

              }
              break;
            case "VB":
              {
                lvl = parseInt(f[0].properties.ZONE_);
                msg += "<p class='aicuz'>" + lvl + "</p>";

              }
              break;
            default:
              {
                msg += "<p>You are NOT in any AICUZ Noise Zone</p>";
              }

          }
          return;
        }
      }

    });

    switch (lvl) {
      case 50:
        {
          d3.select("#aicuz").classed("_50", true);
        }
        break;
      case 55:
        {
          d3.select("#aicuz").classed("_55", true);
        }
        break;
      case 60:
        {
          d3.select("#aicuz").classed("_60", true);
        }
        break;
      case 65:
        {
          d3.select("#aicuz").classed("_65", true);
        }
        break;
      case 70:
        {
          d3.select("#aicuz").classed("_70", true);
        }
        break;
      case 75:
        {
          d3.select("#aicuz").classed("_75", true);
        }
        break;
      case 80:
        {
          d3.select("#aicuz").classed("_80", true);
        }
        break;
      case 85:
        {
          d3.select("#aicuz").classed("_85", true);
        }
        break;
    }

    return msg;
  }

  function checkFeaturesForFloodZone(features, ll, city) {
    var msg = "";
    var lvl = 0;
    $(features).each(function() {
      var f = $(this);
      if (f && f[0]) {
        if (d3.geoContains(f[0], ll)) {
          var fz = f[0].properties.FLD_ZONE;
          console.log(fz);
          msg += "<p class='flood'>" + fz + "</p>";
          return;
        }
      }
    });
    return msg;
  }

  $(document).ready(function() {
    getLocation();
  })
</script>

</html>
