<!DOCTYPE html>
<html>

<head>
  <title>Property Buddy</title>
  <meta charset="utf-8">
  <style type="text/css">
  body {
    font-family: sans-serif;
    font-size: 2em;
    text-align: center;
  }

  #msg {
    font-size: 3em;
  }
  </style>
</head>

<body>
  <div id="msg"><p>Searching...</p></div>
</body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/d3-collection.v1.min.js"></script>
<script src="//d3js.org/d3-dispatch.v1.min.js"></script>
<script src="//d3js.org/d3-dsv.v1.min.js"></script>
<script src="//d3js.org/d3-request.v1.min.js"></script>
<script src="//d3js.org/d3-array.v1.min.js"></script>
<script src="//d3js.org/d3-geo.v1.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script>
  function checkAICUZ(position) {

    console.log("Checking AICUZ for position:");
    console.log(position);

    var ll = [position.coords.longitude, position.coords.latitude];
    //var ll = [-76.195987, 36.893076]; // NFK

    d3.json("geojson/Norfolk.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in NFK");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is NFK");
        checkAICUZ_NFK(ll);
      } else {
        console.log("Location is not in NFK")
      }
    });

    d3.json("geojson/VirginiaBeach.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in VB");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is VB");
        checkAICUZ_VB(ll);
      } else {
        console.log("Location is not in VB")
      }
    });

  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(checkAICUZ);
    } else {
      d3.select("body").append("span")
        .text("Geolocation is not supported by this browser.");
    }
  }

  function checkAICUZ_NFK(ll) {
    d3.request("https://data-orf.opendata.arcgis.com/datasets/c8de1a1f81e14eacbe381ae342318031_8.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p>You are in Norfolk AICUZ Noise Zone:</p>";

        msg += checkFeaturesForZone(data.features, ll, "NFK");


        d3.select("#msg").html(msg);

      });
  }

  function checkAICUZ_VB(ll) {
    d3.request("https://gis-vbgov.opendata.arcgis.com/datasets/3088488c6c284f3981d61b9efe9c1d04_3.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p>You are in Virginia Beach AICUZ Noise Zone:</p>";

        msg += checkFeaturesForZone(data.features, ll, "VB");

        d3.select("#msg").html(msg);

      });
  }

  function checkFeaturesForZone(features, ll, city) {
    var msg = "";
    $(features).each(function() {
      var f = $(this);
      if (f && f[0]) {
        if (d3.geoContains(f[0], ll)) {
          switch (city) {
            case "NFK": {
              msg += "<p>" + f[0].properties.NOISE_LEV_ + "</p>";

            }
            break;
            case "VB": {
              msg += "<p>" + f[0].properties.ZONE_ + "</p>";

            }
            break;
            default: {
              msg += "<p>You are NOT in any AICUZ Noise Zone</p>";
            }

          }
          return;
        }
      }

    })
    return msg;
  }

  $(document).ready(function() {
    getLocation();
  })
</script>

</html>
